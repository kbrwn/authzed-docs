import { Callout } from 'nextra/components'

# Datastores

In order to reduce operational complexity, SpiceDB leverages existing, popular systems for persisting data.

Each datastore implementation comes with various trade-offs.

- [CockroachDB](#cockroachdb) - Recommended for planet-scale, multi-region deployments
- [Cloud Spanner](#cloud-spanner) - Recommended for Google Cloud deployments
- [PostgreSQL](#postgresql) - Recommended for single-region deployments
- [MySQL](#mysql) - Not recommended; only use if you cannot use PostgreSQL
- [memdb](#memdb) - Recommended for local development and integration testing against applications

## Migrations

Before a datastore can be used by SpiceDB or before running a new version of SpiceDB, you must execute all available migrations.

<Callout type="info">
  The only exception is the [memdb datastore](#memdb) because it does not persist any data.
</Callout>

In order to migrate a datastore, run the following command with your desired values:

```
spicedb migrate head \
    --datastore-engine $DESIRED_ENGINE \
    --datastore-conn-uri $CONNECTION_STRING
```

For more information, refer to the [Datastore Migration documentation](/spicedb/concepts/datastore-migrations).

## CockroachDB

### Usage Notes

<Callout type="warning">
  SpiceDB's Watch API requires CockroachDB's [Experimental Changefeed] to be enabled.

  [Experimental Changefeed]: https://www.cockroachlabs.com/docs/v22.1/changefeed-for
</Callout>

- Recommended for multi-region deployments, with configurable region awareness
- Enables horizontally scalability by adding more SpiceDB and CockroachDB instances
- Resiliency to individual CockroachDB instance failures
- Query and data balanced across the CockroachDB cluster
- Setup and operational complexity of running CockroachDB

### Developer Notes

- Code can be found [here][crdb-code]
- Documentation can be found [here][crdb-godoc]
- Implemented using [pgx][pgx] for a SQL driver and connection pooling
- Has a native changefeed
- Stores migration revisions using the same strategy as [Alembic][alembic]

[crdb-code]: https://github.com/authzed/spicedb/tree/main/internal/datastore/crdb
[crdb-godoc]: https://pkg.go.dev/github.com/authzed/spicedb/internal/datastore/crdb
[pgx]: https://pkg.go.dev/gopkg.in/jackc/pgx.v3
[alembic]: https://alembic.sqlalchemy.org/en/latest/

### Configuration

#### Required Parameters

| Parameter            | Description                               | Example                                                                                   |
|----------------------|-------------------------------------------|-------------------------------------------------------------------------------------------|
| `datastore-engine`   | The datastore engine                      | `--datastore-engine=cockroachdb`                                                          |
| `datastore-conn-uri` | Connection string used to connect to CRDB | `--datastore-conn-uri="postgres://user:password@localhost:26257/spicedb?sslmode=disable"` |

#### Optional Parameters

| Parameter                                            | Description                                                                                                                                                 | Example                                                                                                                                       |
|------------------------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------|
| `datastore-max-tx-retries`                           | Number of times a retriable transaction should be retried                                                                                                   | `--datastore-max-tx-retries=10`                                                                                                               |
| `datastore-tx-overlap-strategy`                      | Strategy to generate transaction overlap keys (`"request"`, `"prefix"`, `"static"`, `"insecure"`) (CockroachDB only)                                        | `--datastore-tx-overlap-strategy=static`                                                                                                      |
| `datastore-tx-overlap-key`                           | Static key to touch when writing to ensure transactions overlap (used if `--datastore-tx-overlap-strategy=static`; CockroachDB only)                         | `--datastore-tx-overlap-key="key"`                                                                                                            |
| `datastore-conn-pool-read-max-open`                  | Number of concurrent connections open in the read connection pool                                                                                           | `--datastore-conn-pool-read-max-open=20`                                                                                                      |
| `datastore-conn-pool-read-min-open`                  | Minimum number of concurrent connections open in the read connection pool                                                                                   | `--datastore-conn-pool-read-min-open=20`                                                                                                      |
| `datastore-conn-pool-read-max-lifetime`              | Maximum lifetime of a connection in the read connection pool                                                                                                | `--datastore-conn-pool-read-max-lifetime=30m`                                                                                                 |
| `datastore-conn-pool-read-max-lifetime-jitter`       | Waits a random duration after a connection is open for max lifetime to actually close the connection (default: 20% of max lifetime)                         | `--datastore-conn-pool-read-max-lifetime-jitter=6m`                                                                                           |
| `datastore-conn-pool-read-max-idletime`              | Maximum idle time of a connection in the read connection pool                                                                                               | `--datastore-conn-pool-read-max-idletime=30m`                                                                                                 |
| `datastore-conn-pool-read-healthcheck-interval`      | Time between connection health checks in the read connection pool                                                                                           | `--datastore-conn-pool-read-healthcheck-interval=30s`                                                                                         |
| `datastore-conn-pool-write-max-open`                 | Number of concurrent connections open in the write connection pool                                                                                          | `--datastore-conn-pool-write-max-open=10`                                                                                                     |
| `datastore-conn-pool-write-min-open`                 | Minimum number of concurrent connections open in the write connection pool                                                                                  | `--datastore-conn-pool-write-min-open=10`                                                                                                     |
| `datastore-conn-pool-write-max-lifetime`             | Maximum lifetime of a connection in the write connection pool                                                                                               | `--datastore-conn-pool-write-max-lifetime=30m`                                                                                                |
| `datastore-conn-pool-write-max-lifetime-jitter`      | Waits a random duration after a connection is open for max lifetime to actually close the connection (default: 20% of max lifetime)                         | `--datastore-conn-pool-write-max-lifetime-jitter=6m`                                                                                          |
| `datastore-conn-pool-write-max-idletime`             | Maximum idle time of a connection in the write connection pool                                                                                              | `--datastore-conn-pool-write-max-idletime=30m`                                                                                                |
| `datastore-conn-pool-write-healthcheck-interval`     | Time between connection health checks in the write connection pool                                                                                          | `--datastore-conn-pool-write-healthcheck-interval=30s`                                                                                        |
| `datastore-follower-read-delay-duration`             | Amount of time to subtract from non-sync revision timestamps to ensure they are sufficiently in the past to enable follower reads (CockroachDB only)        | `--datastore-follower-read-delay-duration=4.8s`                                                                                               |
| `datastore-relationship-integrity-enabled`           | Enables relationship integrity checks (only supported on CockroachDB)                                                                                       | `--datastore-relationship-integrity-enabled=true`                                                                                             |
| `datastore-relationship-integrity-current-key-id`    | Current key ID for relationship integrity checks                                                                                                            | `--datastore-relationship-integrity-current-key-id="key-id"`                                                                                  |
| `datastore-relationship-integrity-current-key-filename` | Current key filename for relationship integrity checks                                                                                                  | `--datastore-relationship-integrity-current-key-filename="key-file.pem"`                                                                      |
| `datastore-relationship-integrity-expired-keys`      | Configuration for expired keys for relationship integrity checks                                                                                            | `--datastore-relationship-integrity-expired-keys='{"key_id":"old-key-id","key_filename":"old-key.pem","expired_at":"2023-01-01T00:00:00Z"}'` |
| `datastore-connection-balancing`                     | Enable connection balancing between database nodes (CockroachDB only)                                                                                       | `--datastore-connection-balancing=true`                                                                                                      |
| `datastore-connect-rate`                             | Rate at which new connections are allowed to the datastore (CockroachDB only)                                                                               | `--datastore-connect-rate=100ms`                                                                                                             |
| `datastore-watch-connect-timeout`                    | Duration the watch connection should wait before timing out (CockroachDB only)                                                                              | `--datastore-watch-connect-timeout=1s`                                                                                                       |

#### Overlap Strategy

In distributed systems, you can trade off consistency for performance.

CockroachDB datastore users that are willing to rely on more subtle guarantees to mitigate the [New Enemy Problem] can configure `--datastore-tx-overlap-strategy`.

[New Enemy Problem]: /spicedb/concepts/zanzibar#new-enemy-problem

The available strategies are:

| Strategy   | Description                                                                                                                                                                   |
|------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `static`   | All writes overlap to guarantee safety at the cost of write throughput                                                                                                        |
| `prefix`   | Only writes that contain objects with the same prefix overlap (e.g., `tenant1/user` and `tenant2/user` can be written concurrently)                                           |
| `request`  | Only writes with the same `io.spicedb.requestoverlapkey` header overlap, enabling applications to decide on-the-fly which writes have causal dependencies. Others act as `insecure`. |
| `insecure` | No writes overlap, providing the best write throughput, but possibly leaving you vulnerable to the [New Enemy Problem]                                                        |

For more information, refer to the [CockroachDB datastore README][crdb-readme] or our blog post "[The One Crucial Difference Between Spanner and CockroachDB][crdb-blog]".

[crdb-readme]: https://github.com/authzed/spicedb/blob/main/internal/datastore/crdb/README.md
[crdb-blog]: https://authzed.com/blog/prevent-newenemy-cockroachdb


#### Garbage Collection Window

<Callout type="info">
  As of February 2023, the [default garbage collection window] has changed to `1.25 hours` for CockroachDB Serverless and `4 hours` for CockroachDB Dedicated.

  [default garbage collection window]: https://github.com/cockroachdb/cockroach/issues/89233
</Callout>

SpiceDB warns if the garbage collection window as configured in CockroachDB is smaller than the SpiceDB configuration.

If you need a longer time window for the Watch API or querying at exact snapshots, you can [adjust the value in CockroachDB][crdb-gc]:

```sql
ALTER ZONE default CONFIGURE ZONE USING gc.ttlseconds = 90000;
```

[crdb-gc]: https://www.cockroachlabs.com/docs/stable/configure-replication-zones.html#replication-zone-variables

#### Relationship Integrity

Relationship Integrity is a new experimental feature in SpiceDB that ensures that data written into the supported backing datastores (currently: only CockroachDB) is validated as having been written by SpiceDB itself.

- **What does relationship integrity ensure?**
Relationship integrity primarily ensures that all relationships written into the backing datastore were written via a trusted instance of SpiceDB or that the caller has access to the key(s) necessary to write those relationships.
It ensures that if someone gains access to the underlying datastore, they cannot simply write new relationships of their own invention.

- **What does relationship integrity *not* ensure?**
Since the relationship integrity feature signs each individual relationship, it does not ensure that removal of relationships is by a trusted party.
Schema is also currently unverified, so an untrusted party could change it as well.
Support for schema changes will likely come in a future version.

**Setting up relationship integrity**
To run with relationship integrity, new flags must be given to SpiceDB:

```zed
spicedb serve ...existing flags...
--datastore-relationship-integrity-enabled
--datastore-relationship-integrity-current-key-id="somekeyid"
--datastore-relationship-integrity-current-key-filename="some.key"
```

Place the generated key contents (which must support an HMAC key) in `some.key`

Deployment Process

1. Start with a **clean** datastore for SpiceDB. **At this time, migrating an existing SpiceDB installation is not supported.**
2. Run the standard `migrate` command but with relationship integrity flags included.
3. Run SpiceDB with the relationship integrity flags included.


## Cloud Spanner

### Usage Notes

- Requires a Google Cloud Account with an active Cloud Spanner instance
- Takes advantage of Google's TrueTime.
  The Spanner driver assumes the database is linearizable and skips the transaction overlap strategy required by CockroachDB.

### Developer Notes

- Code can be found [here][spanner-code]
- Documentation can be found [here][spanner-godoc]
- Starts a background [GC worker][gc-process] to clean up old entries from the manually generated changelog table

[spanner-code]: https://github.com/authzed/spicedb/tree/main/internal/datastore/spanner
[spanner-godoc]: https://pkg.go.dev/github.com/authzed/spicedb/internal/datastore/spanner
[gc-process]: https://github.com/authzed/spicedb/blob/main/internal/datastore/common/gc.go

### Configuration

#### Required Parameters

| Parameter            | Description                           | Example                                                                                  |
|----------------------|---------------------------------------|------------------------------------------------------------------------------------------|
| `datastore-engine`   | The datastore engine                  | `--datastore-engine=spanner`                                                             |
| `datastore-conn-uri` | The Cloud Spanner database identifier | `--datastore-conn-uri="projects/project-id/instances/instance-id/databases/database-id"` |

#### Optional Parameters

| Parameter                                            | Description                                                                                                                                       | Example                                                      |
|------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------|
| `datastore-spanner-credentials`                      | Path to service account key credentials file with access to the Cloud Spanner instance (omit to use application default credentials)              | `--datastore-spanner-credentials=./spanner.json`             |
| `datastore-spanner-emulator-host`                    | URI of Spanner emulator instance used for development and testing (e.g., `localhost:9010`)                                                        | `--datastore-spanner-emulator-host=localhost:9010`           |
| `datastore-spanner-min-sessions`                     | Minimum number of sessions across all Spanner gRPC connections the client can have at a given time                                                | `--datastore-spanner-min-sessions=100`                       |
| `datastore-spanner-max-sessions`                     | Maximum number of sessions across all Spanner gRPC connections the client can have at a given time                                                | `--datastore-spanner-max-sessions=400`                       |
| `datastore-watch-buffer-length`                      | Size of the watch buffer before blocking                                                                                                          | `--datastore-watch-buffer-length=1024`                       |
| `datastore-watch-buffer-write-timeout`               | Duration the watch buffer should queue before forcefully disconnecting the reader                                                                 | `--datastore-watch-buffer-write-timeout=1s`                  |

## PostgreSQL

### Usage Notes

- Recommended for single-region deployments
- Postgres 15 or newer is required for optimal performance
- Resiliency to failures only when PostgreSQL is operating with a follower and proper failover
- Carries setup and operational complexity of running PostgreSQL
- Does not rely on any non-standard PostgreSQL extensions
- Compatible with managed PostgreSQL services (e.g. AWS RDS)
- Can be scaled out on read workloads using read replicas

<Callout type="warning">
  SpiceDB's Watch API requires PostgreSQL's [Commit Timestamp tracking][commit-ts] to be enabled.

  This can be done by providing the `--track_commit_timestamp=on` flag, configuring `postgresql.conf`, or executing `ALTER SYSTEM SET track_commit_timestamp = on;` and restarting the instance.

  [commit-ts]: https://www.postgresql.org/docs/current/runtime-config-replication.html#GUC-TRACK-COMMIT-TIMESTAMP
</Callout>

### Developer Notes

- Code can be found [here][pg-code]
- Documentation can be found [here][pg-godoc]
- Implemented using [pgx][pgx] for a SQL driver and connection pooling
- Stores migration revisions using the same strategy as [Alembic][alembic]
- Implements its own [MVCC][mvcc] model by storing its data with transaction IDs

[pg-code]: https://github.com/authzed/spicedb/tree/main/internal/datastore/postgres
[pg-godoc]: https://pkg.go.dev/github.com/authzed/spicedb/internal/datastore/postgres
[mvcc]: https://en.wikipedia.org/wiki/Multiversion_concurrency_control

### Read Replicas

SpiceDB supports Postgres read replicas and does it while retaining consistency guarantees.
Typical use cases are:

- scale read workloads/offload reads from the primary
- deploy SpiceDB in other regions with primarily read workloads

Read replicas are typically configured with asynchronous replication, which involves replication lag.
That would be problematic to SpiceDB's ability to solve the new enemy problem but it addresses the challenge by checking if a revision has been replicated into the target replica.
If missing, it will fall back to the primary.

All API consistency options will leverage replicas, but the ones that benefit the most are those that involve some level of staleness as it increases the odds a revision has replicated.
`minimize_latency`, `at_least_as_fresh`, and `at_exact_snapshot` consistency modes have the highest chance of being redirected to a replica.

SpiceDB supports Postgres replicas behind a load-balancer, and/or individually listing replica hosts.
When multiple URIs are provided, they will be queried using a round-robin strategy.  
Please note that the maximum number of replica URIs to list is 16.

Read replicas are configured with the `--datastore-read-replica-*` family of flags.

SpiceDB supports [PgBouncer](https://www.pgbouncer.org/) connection pooler and is part of the test suite.

#### Transaction IDs and MVCC

The Postgres implementation of SpiceDB's internal MVCC mechanism involves storing the internal transaction ID count associated with a given transaction
in the rows written in that transaction.
Because this counter is instance-specific, there are ways in which the data in the datastore can become desynced with that internal counter.
Two concrete examples are the use of `pg_dump` and `pg_restore` to transfer data between an old instance and a new instance and setting up
logical replication between a previously-existing instance and a newly-created instance.

If you encounter this, SpiceDB can behave as though there is no schema written, because the data (including the schema) is associated with a future transaction ID and therefore
isn't "visible" to Spicedb.
You may see an error like this:

```
FAILED_PRECONDITION: object definition `some_definition` not found
```

If this occurs, you can use `spicedb datastore repair` (along with your usual datastore flags) to roll the transaction counter of the database forward until SpiceDB is able to resume normal operation:

```
spicedb datastore repair --datastore-engine=postgres --datastore-conn-uri=$DATASTORE_URI
```

#### Required Parameters

| Parameter            | Description                                     | Example                                                                                      |
|----------------------|-------------------------------------------------|----------------------------------------------------------------------------------------------|
| `datastore-engine`   | The datastore engine                            | `--datastore-engine=postgres`                                                                |
| `datastore-conn-uri` | Connection string used to connect to PostgreSQL | `--datastore-conn-uri="postgres://postgres:password@localhost:5432/spicedb?sslmode=disable"` |

#### Optional Parameters

| Parameter                                | Description                                                                                                   | Example                                                               |
|------------------------------------------|---------------------------------------------------------------------------------------------------------------|-----------------------------------------------------------------------|
| `datastore-conn-max-open`                | Maximum number of concurrent connections to open                                                              | `--datastore-conn-max-open=50`                                        |
| `datastore-conn-min-open`                | Minimum number of concurrent connections to maintain                                                          | `--datastore-conn-min-open=10`                                        |
| `datastore-conn-max-lifetime`            | Maximum lifetime for a connection before it is recycled                                                       | `--datastore-conn-max-lifetime=30m`                                   |
| `datastore-conn-max-idletime`            | Maximum idle time for a connection before it is recycled                                                      | `--datastore-conn-max-idletime=10m`                                   |
| `datastore-gc-window`                    | Sets the window outside of which overwritten relationships are no longer accessible                           | `--datastore-gc-window=24h`                                           |
| `datastore-revision-quantization-interval` | Boundary interval to which to round the quantized revision                                                    | `--datastore-revision-quantization-interval=5s`                       |
| `datastore-revision-quantization-max-staleness-percent` | Percentage of the quantization interval to allow for stale revisions for performance                      | `--datastore-revision-quantization-max-staleness-percent=0.1`         |
| `datastore-read-replica-conn-uri`        | Connection string used by read replicas; supports up to 16 URIs                                                | `--datastore-read-replica-conn-uri="postgres://replica:password@host"`|
| `datastore-read-replica-credentials-provider-name` | Retrieve credentials dynamically using providers such as AWS IAM                                           | `--datastore-read-replica-credentials-provider-name="aws-iam"`        |
| `datastore-read-replica-conn-pool-read-max-open` | Maximum number of connections in the read replica connection pool                                              | `--datastore-read-replica-conn-pool-read-max-open=20`                 |
| `datastore-read-replica-conn-pool-read-min-open` | Minimum number of connections in the read replica connection pool                                              | `--datastore-read-replica-conn-pool-read-min-open=5`                  |
| `datastore-read-replica-conn-pool-read-max-lifetime` | Maximum lifetime of connections in the read replica connection pool                                           | `--datastore-read-replica-conn-pool-read-max-lifetime=30m`            |
| `datastore-read-replica-conn-pool-read-healthcheck-interval` | Frequency of health checks for connections in the read replica pool                                           | `--datastore-read-replica-conn-pool-read-healthcheck-interval=1m`     |

## MySQL

### Usage Notes

- Recommended for single-region deployments
- Setup and operational complexity of running MySQL
- Does not rely on any non-standard MySQL extensions
- Compatible with managed MySQL services
- Can be scaled out on read workloads using read replicas

### Developer Notes

- Code can be found [here][mysql-code]
- Documentation can be found [here][mysql-godoc]
- Implemented using [Go-MySQL-Driver][go-mysql-driver] for a SQL driver
- Query optimizations are documented [here][mysql-executor]
- Implements its own [MVCC][mysql-mvcc] model by storing its data with transaction IDs

[mysql-code]: https://github.com/authzed/spicedb/tree/main/internal/datastore/mysql
[mysql-godoc]: https://pkg.go.dev/github.com/authzed/spicedb/internal/datastore/mysql
[go-mysql-driver]: https://github.com/go-sql-driver/mysql
[mysql-executor]: https://github.com/authzed/spicedb/blob/main/internal/datastore/mysql/datastore.go#L317
[mysql-mvcc]: https://en.wikipedia.org/wiki/Multiversion_concurrency_control

### Read Replicas

<Callout type="warning">
Do not use a load balancer between SpiceDB and MySQL replicas because SpiceDB will not be able to maintain consistency guarantees.
</Callout>

SpiceDB supports MySQL read replicas and does it while retaining consistency guarantees.
Typical use cases are:

- scale read workloads/offload reads from the primary
- deploy SpiceDB in other regions with primarily read workloads

Read replicas are typically configured with asynchronous replication, which involves replication lag.
That would be problematic to SpiceDB's ability to solve the new enemy problem but it addresses the challenge by checking if the revision has been replicated into the target replica.
If missing, it will fall back to the primary.
Compared to the Postgres implementation, MySQL support requires two roundtrips instead of one, which means it adds some extra latency overhead.

All API consistency options will leverage replicas, but the ones that benefit the most are those that involve some level of staleness as it increases the odds a revision has replicated.
`minimize_latency`, `at_least_as_fresh`, and `at_exact_snapshot` consistency modes have the highest chance of being redirected to a replica.

SpiceDB does not support MySQL replicas behind a load-balancer: you may only list replica hosts individually.
Failing to adhere to this would compromise consistency guarantees.
When multiple host URIs are provided, they will be queried using round-robin.
Please note that the maximum number of MySQL replica host URIs to list is 16.

Read replicas are configured with the `--datastore-read-replica-*` family of flags.

### Configuration

#### Required Parameters

| Parameter            | Description                                | Example                                                                                       |
| -------------------- | ------------------------------------------ | --------------------------------------------------------------------------------------------- |
| `datastore-engine`   | the datastore engine                       | `--datastore-engine=mysql`                                                                    |
| `datastore-conn-uri` | connection string used to connect to MySQL | `--datastore-conn-uri="user:password@(localhost:3306)/spicedb?parseTime=True"`                |

<Callout type="warning">
  SpiceDB requires `--datastore-conn-uri` to contain the query parameter `parseTime=True`.
</Callout>

#### Optional Parameters

| Parameter                             | Description                                                                         | Example                                      |
| ------------------------------------- | ----------------------------------------------------------------------------------- | -------------------------------------------- |
| `datastore-conn-max-idletime`         | Maximum idle time for a connection before it is recycled                            | `--datastore-conn-max-idletime=60s`          |
| `datastore-conn-max-lifetime`         | Maximum lifetime for a connection before it is recycled                             | `--datastore-conn-max-lifetime=300s`         |
| `datastore-conn-max-open`             | Maximum number of concurrent connections to open                                    | `--datastore-conn-max-open=10`               |
| `datastore-query-split-size`          | The (estimated) query size at which to split a query into multiple queries          | `--datastore-query-split-size=5kb`           |
| `datastore-gc-window`                 | Sets the window outside of which overwritten relationships are no longer accessible | `--datastore-gc-window=1s`                   |
| `datastore-revision-fuzzing-duration` | Sets a fuzzing window on all zookies/zedtokens                                      | `--datastore-revision-fuzzing-duration=50ms` |
| `datastore-mysql-table-prefix string` | Prefix to add to the name of all SpiceDB database tables                            | `--datastore-mysql-table-prefix=spicedb`     |
| `datastore-readonly`                  | Places the datastore into readonly mode                                             | `--datastore-readonly=true`                  |
| `datastore-read-replica-conn-uri`     | Connection string used by datastores for read replicas; only supported for postgres and MySQL | `--datastore-read-replica-conn-uri="postgres://postgres:password@localhost:5432/spicedb\"` |
| `—datastore-read-replica-credentials-provider-name`               | Retrieve datastore credentials dynamically using aws-iam                      |                 |
| --datastore-read-replica-conn-pool-read-healthcheck-interval      | amount of time between connection health checks in a read-only replica datastore's connection pool | `--datastore-read-replica-conn-pool-read-healthcheck-interval=30s` |
| --datastore-read-replica-conn-pool-read-max-idletime              | maximum amount of time a connection can idle in a read-only replica datastore's connection pool | `--datastore-read-replica-conn-pool-read-max-idletime=30m` |
| --datastore-read-replica-conn-pool-read-max-lifetime              | maximum amount of time a connection can live in a read-only replica datastore's connection pool | `--datastore-read-replica-conn-pool-read-max-lifetime=30m` |
| --datastore-read-replica-conn-pool-read-max-lifetime-jitter       | waits rand(0, jitter) after a connection is open for max lifetime to actually close the connection to a read replica(default: 20% of max lifetime) | `--datastore-read-replica-conn-pool-read-max-lifetime-jitter=6m` |
| --datastore-read-replica-conn-pool-read-max-open                  | number of concurrent connections open in a read-only replica datastore's connection pool | `--datastore-read-replica-conn-pool-read-max-open=20` |
| --datastore-read-replica-conn-pool-read-min-open                  | number of minimum concurrent connections open in a read-only replica datastore's connection pool | `--datastore-read-replica-conn-pool-read-min-open=20` |

## memdb

### Usage Notes

- Fully ephemeral; *all* data is lost when the process is terminated
- Intended for usage with SpiceDB itself and testing application integrations
- Cannot be ran highly-available as multiple instances will not share the same in-memory data

<Callout type="info">
  If you need an ephemeral datastore designed for validation or testing, see the test server system in [Validating and Testing]
</Callout>

[validating and testing]: /spicedb/modeling/validation-testing-debugging

### Developer Notes

- Code can be found [here][memdb-code]
- Documentation can be found [here][memdb-godoc]
- Implements its own [MVCC][mvcc] model by storing its data with transaction IDs

[memdb-code]: https://github.com/authzed/spicedb/tree/main/internal/datastore/memdb
[memdb-godoc]: https://pkg.go.dev/github.com/authzed/spicedb/internal/datastore/memdb

### Configuration

#### Required Parameters

| Parameter          | Description          | Example                     |
| ------------------ | -------------------- | --------------------------- |
| `datastore-engine` | the datastore engine | `--datastore-engine memory` |

#### Optional Parameters

| Parameter                             | Description                                                                         | Example                                      |
| ------------------------------------- | ----------------------------------------------------------------------------------- | -------------------------------------------- |
| `datastore-revision-fuzzing-duration` | Sets a fuzzing window on all zookies/zedtokens                                      | `--datastore-revision-fuzzing-duration=50ms` |
| `datastore-gc-window`                 | Sets the window outside of which overwritten relationships are no longer accessible | `--datastore-gc-window=1s`                   |
| `datastore-readonly`                  | Places the datastore into readonly mode                                             | `--datastore-readonly=true`                  |

## Common Configuration Flags

These flags apply to all datastore engines:

### Required Parameters

| Parameter            | Description                                     | Example                                                                                      |
|----------------------|-------------------------------------------------|----------------------------------------------------------------------------------------------|
| `datastore-engine`   | The datastore engine                            | `--datastore-engine=postgres`                                                                |
| `datastore-conn-uri` | Connection string used to connect to the datastore | `--datastore-conn-uri="postgres://user:password@localhost:5432/spicedb?sslmode=disable"`     |

### Optional Parameters

| Parameter                                         | Description                                                                                                               | Example                                                      |
|---------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------|
| `datastore-gc-window`                             | Amount of time before revisions are garbage collected                                                                     | `--datastore-gc-window=24h`                                  |
| `datastore-revision-quantization-interval`        | Boundary interval to which to round the quantized revision                                                                | `--datastore-revision-quantization-interval=5s`              |
| `datastore-revision-quantization-max-staleness-percent` | Percentage of the quantization interval to allow for stale revisions for performance                                  | `--datastore-revision-quantization-max-staleness-percent=0.1`|
| `datastore-readonly`                              | Set the service to read-only mode                                                                                         | `--datastore-readonly=true`                                  |
| `datastore-bootstrap-files`                       | Bootstrap data YAML files to load                                                                                         | `--datastore-bootstrap-files="schema.yaml,data.yaml"`        |
| `datastore-bootstrap-overwrite`                   | Overwrite any existing data with bootstrap data (can be slow)                                                             | `--datastore-bootstrap-overwrite=true`                       |
| `datastore-bootstrap-timeout`                     | Maximum duration before timeout for the bootstrap data to be written                                                      | `--datastore-bootstrap-timeout=10s`                          |
| `datastore-request-hedging`                       | Enable request hedging                                                                                                    | `--datastore-request-hedging=true`                           |
| `datastore-request-hedging-initial-slow-value`    | Initial value to use for slow datastore requests before statistics are collected                                          | `--datastore-request-hedging-initial-slow-value=20ms`        |
| `datastore-request-hedging-max-requests`          | Maximum number of historical requests to consider                                                                         | `--datastore-request-hedging-max-requests=1000000`           |
| `datastore-request-hedging-quantile`              | Quantile of historical request times over which a request is considered slow                                              | `--datastore-request-hedging-quantile=0.9`                   |
| `datastore-prometheus-metrics`                    | Enable or disable Prometheus metrics                                                                                      | `--datastore-prometheus-metrics=true`                        |
| `datastore-watch-buffer-length`                   | Size of the watch buffer before blocking                                                                                  | `--datastore-watch-buffer-length=1024`                       |
| `datastore-watch-buffer-write-timeout`            | Duration the watch buffer should queue before forcefully disconnecting the reader                                         | `--datastore-watch-buffer-write-timeout=1s`                  |